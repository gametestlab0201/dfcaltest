<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta charset="UTF-8" />
  <title>ë˜íŒŒ ë°ë¯¸ì§€ ê³„ì‚°ê¸°</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background-color: #f4f6f8;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      gap: 16px;
    }
    .panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      flex: 1 1 30%;
      min-width: 300px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 12px;
      text-align: center;
    }
    #loginBox {
      padding: 20px;
      text-align: center;
    }
    #loginBox input {
      margin: 4px;
      padding: 8px;
      width: 200px;
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div id="g_id_onload"
     data-client_id="1011549977562-qpih8umnatggo5as43lp0t1h0312se5a.apps.googleusercontent.com"
     data-callback="onGoogleLogin"
     data-auto_prompt="false"></div>
<div class="g_id_signin"
     data-type="standard"
     data-size="large"
     data-theme="outline"
     data-text="sign_in_with"
     data-shape="rectangular"
     data-logo_alignment="left">
</div>

<script>
let userIdToken = "";

function onGoogleLogin(response) {
  userIdToken = response.credential;
  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: "type=oauth_login&idToken=" + encodeURIComponent(userIdToken)
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      localStorage.setItem("userEmail", data.email);
      localStorage.setItem("userLevel", data.level);
      alert("âœ… ë¡œê·¸ì¸ ì„±ê³µ: " + data.email);
      loadItems();
      loadSkills();
      loadFormulas();
    } else {
      // ì—¬ê¸°ì„œ ê¸°ì¡´ ìƒíƒœë¥¼ ë¦¬ì…‹!
      localStorage.removeItem("userEmail");
      localStorage.removeItem("userLevel");
      alert("âŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤)");
      location.reload();  // or UIë¥¼ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
    }
  });
}
</script>
  
  <div class="container">
    <div class="panel" id="equipPanel">
      <h2>â‘  ì¥ë¹„ ì„ íƒ</h2>
      <div id="equipList">ì—¬ê¸°ì— ì•„ì´í…œ ëª©ë¡ í‘œì‹œ ì˜ˆì •</div>
    </div>
    <div class="panel" id="skillPanel">
      <h2>â‘¡ ìŠ¤í‚¬ ì„ íƒ</h2>
      <div id="skillList">ì—¬ê¸°ì— ìŠ¤í‚¬ ëª©ë¡ í‘œì‹œ ì˜ˆì •</div>
    </div>
    <div class="panel" id="optionPanel">
      <h2>â‘¢ ì˜µì…˜ & ê²°ê³¼</h2>
      <div id="optionArea">
        <button onclick="calculateDamage()">ê³„ì‚°í•˜ê¸°</button>
        <div id="result">ê²°ê³¼: -</div>
      </div>
      <div id="adminPanel" style="margin-top:20px; display:none;">
        <h3>âš™ï¸ ê³µì‹ ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©)</h3>
        <textarea id="formulaEditor" rows="4" style="width:100%;"></textarea>
        <button onclick="saveFormula()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbzSmwf_XpsOeB0_n-9nQ458eYfUQev12twevYKdMO9IjElUQaHRMTOTZWE62QRiG_FP3g/exec";

    let selectedItem = null;
    let selectedSkill = null;
    let formulas = {};

    function loadItems() {
  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: "type=items&idToken=" + encodeURIComponent(userIdToken)
  })
  .then(res => res.json())
  .then(data => { /* ... */ });
}

    function loadSkills() {
      fetch(SHEETS_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "type=skills&idToken=" + encodeURIComponent(userIdToken)
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("skillList");
        container.innerHTML = '';
        data.forEach(skill => {
          const div = document.createElement("div");
          div.textContent = `${skill.ìŠ¤í‚¬ëª…} (ê³„ìˆ˜ ${skill.ê³„ìˆ˜})`;
          div.style.cssText = 'border:1px solid #ccc; padding:6px; margin-bottom:4px; cursor:pointer;';
          div.onclick = () => {
            selectedSkill = skill;
            highlightSelected(div, container);
          };
          container.appendChild(div);
        });
      });
    }

    function loadFormulas() {
  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: "type=formulas&idToken=" + encodeURIComponent(userIdToken)
  })
  .then(res => res.json())
  .then(data => {
    data.forEach(row => {
      formulas[row.key] = row.formula;
    });
  });
}

    function highlightSelected(selectedDiv, container) {
      [...container.children].forEach(child => {
        child.style.background = '';
        child.style.fontWeight = 'normal';
      });
      selectedDiv.style.background = '#eef';
      selectedDiv.style.fontWeight = 'bold';
    }

    function calculateDamage() {
      if (!selectedItem || !selectedSkill) {
        alert("ì¥ë¹„ì™€ ìŠ¤í‚¬ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      const formula = formulas["ê¸°ë³¸ê³„ì‚°ì‹"];
      if (!formula) {
        alert("ê³„ì‚° ìˆ˜ì‹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return;
      }
      const itemStat = Number(selectedItem.í˜ || 0);
      const skillMultiplier = Number(selectedSkill.ê³„ìˆ˜ || 1);
      const expression = formula.replace(/itemStat/g, itemStat).replace(/skillMultiplier/g, skillMultiplier);
      let result;
      try {
        result = eval(expression);
      } catch (e) {
        result = "ì—ëŸ¬: ìˆ˜ì‹ ê³„ì‚° ì‹¤íŒ¨";
      }
      document.getElementById("result").textContent = `ê²°ê³¼: ${result}`;
    }


    
    window.onload = function () {

    };
  </script>
</body>
</html>
