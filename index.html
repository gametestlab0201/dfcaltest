<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë˜íŒŒ ë°ë¯¸ì§€ ê³„ì‚°ê¸°</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f8;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      gap: 16px;
    }
    .panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      flex: 1 1 30%;
      min-width: 300px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 12px;
      text-align: center;
    }

    @media (max-width: 900px) {
      .container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel" id="equipPanel">
      <h2>â‘  ì¥ë¹„ ì„ íƒ</h2>
      <div id="equipList">ì—¬ê¸°ì— ì•„ì´í…œ ëª©ë¡ í‘œì‹œ ì˜ˆì •</div>
    </div>

    <div class="panel" id="skillPanel">
      <h2>â‘¡ ìŠ¤í‚¬ ì„ íƒ</h2>
      <div id="skillList">ì—¬ê¸°ì— ìŠ¤í‚¬ ëª©ë¡ í‘œì‹œ ì˜ˆì •</div>
    </div>

    <div class="panel" id="optionPanel">
      <h2>â‘¢ ì˜µì…˜ & ê²°ê³¼</h2>
      <div id="optionArea">
        <button onclick="calculateDamage()">ê³„ì‚°í•˜ê¸°</button>
        <div id="result">ê²°ê³¼: -</div>
      </div>
<div id="adminPanel" style="margin-top:20px; display:none;">
  <h3>âš™ï¸ ê³µì‹ ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©)</h3>
  <textarea id="formulaEditor" rows="4" style="width:100%;"></textarea>
  <button onclick="saveFormula()">ğŸ’¾ ì €ì¥</button>
</div>

    </div>
  </div>

  <script>
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbzSmwf_XpsOeB0_n-9nQ458eYfUQev12twevYKdMO9IjElUQaHRMTOTZWE62QRiG_FP3g/exec";

let selectedItem = null; // ì„ íƒëœ ì•„ì´í…œ ì €ì¥ìš©

function loadItems() {
  fetch(SHEETS_API_URL + "?type=items")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("equipList");
      container.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement("div");
        div.textContent = `${item.ì´ë¦„} (+${item.í˜ || 0} í˜ / +${item.ì§€ëŠ¥ || 0} ì§€ëŠ¥)`;
        div.style.border = '1px solid #ccc';
        div.style.padding = '6px';
        div.style.marginBottom = '4px';
        div.style.cursor = 'pointer';
        div.onclick = () => {
          selectedItem = item;
          highlightSelected(div, container);
        };
        container.appendChild(div);
      });
    });
}

let selectedSkill = null;

function loadSkills() {
  fetch(SHEETS_API_URL + "?type=skills")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("skillList");
      container.innerHTML = '';
      data.forEach(skill => {
        const div = document.createElement("div");
        div.textContent = `${skill.ìŠ¤í‚¬ëª…} (ê³„ìˆ˜ ${skill.ê³„ìˆ˜})`;
        div.style.border = '1px solid #ccc';
        div.style.padding = '6px';
        div.style.marginBottom = '4px';
        div.style.cursor = 'pointer';
        div.onclick = () => {
          selectedSkill = skill;
          highlightSelected(div, container);
        };
        container.appendChild(div);
      });
    });
}

function highlightSelected(selectedDiv, container) {
  [...container.children].forEach(child => {
    child.style.background = '';
    child.style.fontWeight = 'normal';
  });
  selectedDiv.style.background = '#eef';
  selectedDiv.style.fontWeight = 'bold';
}

let formulas = {};

function loadFormulas() {
  fetch(SHEETS_API_URL + "?type=formulas")
    .then(res => res.json())
    .then(data => {
      data.forEach(row => {
        formulas[row.key] = row.formula;
      });
    });
}


    function calculateDamage() {
  if (!selectedItem || !selectedSkill) {
    alert("ì¥ë¹„ì™€ ìŠ¤í‚¬ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  const formula = formulas["ê¸°ë³¸ê³„ì‚°ì‹"];
  if (!formula) {
    alert("ê³„ì‚° ìˆ˜ì‹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  const itemStat = Number(selectedItem.í˜ || 0); // ì˜ˆì‹œë¡œ 'í˜'ë§Œ ì‚¬ìš©
  const skillMultiplier = Number(selectedSkill.ê³„ìˆ˜ || 1);

  // ìˆ˜ì‹ ë¬¸ìì—´ì„ ë™ì ìœ¼ë¡œ ê³„ì‚°
  const expression = formula
    .replace(/itemStat/g, itemStat)
    .replace(/skillMultiplier/g, skillMultiplier);

  let result;
  try {
    result = eval(expression);
  } catch (e) {
    result = "ì—ëŸ¬: ìˆ˜ì‹ ê³„ì‚° ì‹¤íŒ¨";
  }

  document.getElementById("result").textContent = `ê²°ê³¼: ${result}`;
}

function doGet(e) {
  const type = e.parameter.type || "user";

  // ì‚¬ìš©ì ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸° (ë¡œê·¸ì¸ëœ êµ¬ê¸€ ê³„ì •)
  const email = Session.getActiveUser().getEmail();
  if (!email) {
    return ContentService.createTextOutput(JSON.stringify({ error: "unauthorized" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const usersSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("users");
  const data = usersSheet.getDataRange().getValues();
  const headers = data.shift(); // ì²« ì¤„ì€ í—¤ë”

  const userRow = data.find(row => row[0] === email); // 0ë²ˆì§¸ ì—´ = ì´ë©”ì¼
  const userLevel = userRow ? userRow[2] : "unregistered";

  // ë°ì´í„° ìš”ì²­ ì²˜ë¦¬
  if (type === "user") {
    return ContentService.createTextOutput(JSON.stringify({ email, level: userLevel }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(type);
  if (!sheet) {
    return ContentService.createTextOutput("invalid sheet");
  }

  const sheetData = sheet.getDataRange().getValues();
  const keys = sheetData.shift();
  const json = sheetData.map(row => {
    const obj = {};
    keys.forEach((key, i) => obj[key] = row[i]);
    return obj;
  });

  return ContentService.createTextOutput(JSON.stringify(json)).setMimeType(ContentService.MimeType.JSON);
}


function checkUserLevel() {
  fetch(SHEETS_API_URL)
  .then(res => res.json())
  .then(data => {
    if (data.error === "unauthorized") {
      alert("â— Google ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆê±°ë‚˜, ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜ ì‘ë‹µ:", data);
      return;
    }

    userEmail = data.email;
    userLevel = data.level;

    if (userLevel === "unregistered") {
      alert("ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.");
    } else {
      console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ:", userEmail, "/", userLevel);
      applyUserRestrictions();
    }
  })
  .catch(err => {
    alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
    console.error("Fetch ì‹¤íŒ¨:", err);
  });

}


window.onload = function () {
    loadItems();
    loadSkills();
    loadFormulas();
    checkUserLevel();
  };

  </script>
</body>
</html>
